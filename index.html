<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ AI åŠ©æ‰‹</title>
    <style>
        /* 1. å…¨å±€å¸ƒå±€ï¼šè®©é¡µé¢é€‚åº”æ‰‹æœºå’Œç”µè„‘ */
        body { 
            margin: 0; 
            padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background-color: #f0f2f5; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
        }

        /* 2. é¡¶éƒ¨æ ‡é¢˜æ  */
        header { 
            background-color: #ffffff; 
            padding: 15px; 
            text-align: center; 
            font-weight: bold; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            z-index: 10;
        }

        /* 3. èŠå¤©è®°å½•åŒºåŸŸ (æ ¸å¿ƒ) */
        #chat-container { 
            flex: 1; 
            overflow-y: auto; /* å…è®¸æ»šåŠ¨ */
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; /* æ°”æ³¡ä¹‹é—´çš„é—´è· */
        }

        /* 4. æ°”æ³¡é€šç”¨æ ·å¼ */
        .message { 
            max-width: 80%; 
            padding: 12px 16px; 
            border-radius: 15px; 
            font-size: 15px; 
            line-height: 1.5; 
            word-wrap: break-word; /* é˜²æ­¢é•¿å•è¯æ’‘ç ´æ°”æ³¡ */
            position: relative;
            animation: fadeIn 0.3s ease; /* ç®€å•çš„å‡ºç°åŠ¨ç”» */
        }

        /* ç”¨æˆ·æ°”æ³¡ (å³è¾¹ï¼Œè“è‰²) */
        .user-message { 
            align-self: flex-end; 
            background-color: #0084ff; 
            color: white; 
            border-bottom-right-radius: 4px; /* è¿™æ˜¯ä¸€ä¸ªè®¾è®¡å°ç»†èŠ‚ */
        }

        /* AI æ°”æ³¡ (å·¦è¾¹ï¼Œç°è‰²) */
        .ai-message { 
            align-self: flex-start; 
            background-color: #ffffff; 
            color: #333; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            border-bottom-left-radius: 4px;
        }

        /* 5. åº•éƒ¨è¾“å…¥æ¡†åŒºåŸŸ */
        .input-area { 
            background: white; 
            padding: 15px; 
            display: flex; 
            gap: 10px; 
            border-top: 1px solid #ddd; 
        }

        input { 
            flex: 1; 
            padding: 12px; 
            border: 1px solid #ddd; 
            border-radius: 20px; 
            outline: none; 
            font-size: 16px;
        }

        input:focus { border-color: #0084ff; }

        button { 
            padding: 10px 20px; 
            background-color: #0084ff; 
            color: white; 
            border: none; 
            border-radius: 20px; 
            font-weight: bold; 
            cursor: pointer; 
        }

        button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* åŠ¨ç”»å®šä¹‰ */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* åŠ è½½ä¸­çš„ä¸‰ä¸ªç‚¹åŠ¨ç”» */
        .typing-indicator::after { content: '...'; animation: typing 1.5s infinite; }
        @keyframes typing { 0% { content: '.'; } 33% { content: '..'; } 66% { content: '...'; } }
    </style>
</head>
<body>

    <header>ğŸ¤– Gemini æ™ºèƒ½åŠ©æ‰‹</header>

    <div id="chat-container">
        <div class="message ai-message">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„å—ï¼Ÿ</div>
    </div>

    <div class="input-area">
        <input type="text" id="userInput" placeholder="å‘æ¶ˆæ¯..." onkeypress="handleKeyPress(event)">
        <button id="sendBtn" onclick="sendMessage()">å‘é€</button>
    </div>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');

        // æ ¸å¿ƒåŠŸèƒ½ï¼šæ·»åŠ æ¶ˆæ¯åˆ°å±å¹•
        function appendMessage(text, sender) {
            const div = document.createElement('div');
            div.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message');
            div.innerText = text;
            chatContainer.appendChild(div);
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return div; // è¿”å›è¿™ä¸ªå…ƒç´ æ–¹ä¾¿åç»­ä¿®æ”¹
        }

        // å¤„ç†å›è½¦é”®å‘é€
        function handleKeyPress(e) {
            if (e.key === 'Enter') sendMessage();
        }

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            // 1. æ˜¾ç¤ºç”¨æˆ·çš„æ¶ˆæ¯
            appendMessage(text, 'user');
            userInput.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
            userInput.disabled = true;
            sendBtn.disabled = true;

            // 2. æ˜¾ç¤ºä¸€ä¸ªâ€œæ€è€ƒä¸­â€çš„ä¸´æ—¶æ°”æ³¡
            const loadingBubble = appendMessage('æ€è€ƒä¸­', 'ai');
            loadingBubble.classList.add('typing-indicator'); // åŠ ä¸ŠåŠ¨ç”»

            try {
                // 3. å‘é€ç»™åç«¯
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: text })
                });
                
                const data = await response.json();

                // 4. æ”¶åˆ°å›å¤ï¼šç§»é™¤â€œæ€è€ƒä¸­â€æ ·å¼ï¼Œå¡«å…¥çœŸæ­£çš„å†…å®¹
                loadingBubble.classList.remove('typing-indicator');
                
                if (data.error) {
                    loadingBubble.innerText = "å‡ºé”™äº†: " + data.error;
                    loadingBubble.style.color = "red";
                } else {
                    loadingBubble.innerText = data.text;
                }

            } catch (e) {
                loadingBubble.innerText = "ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚";
            } finally {
                // 5. æ¢å¤è¾“å…¥æ¡†
                userInput.disabled = false;
                sendBtn.disabled = false;
                userInput.focus();
                // å†æ¬¡æ»šåŠ¨åˆ°åº•éƒ¨ç¡®ä¿èƒ½çœ‹åˆ°æœ€æ–°å›å¤
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }
    </script>
</body>
</html>