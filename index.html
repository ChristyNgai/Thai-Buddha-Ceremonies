<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ AI åŠ©æ‰‹ (è®°å¿†ç‰ˆ)</title>
    <style>
        /* æ ·å¼ä¿æŒä¸å˜ï¼Œä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œæˆ‘è¿™é‡Œç›´æ¥æ²¿ç”¨ä¹‹å‰çš„æ ·å¼ */
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f0f2f5; height: 100vh; display: flex; flex-direction: column; }
        header { background-color: #ffffff; padding: 15px; text-align: center; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 10;}
        #chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .message { max-width: 80%; padding: 12px 16px; border-radius: 15px; font-size: 15px; line-height: 1.5; word-wrap: break-word; position: relative; animation: fadeIn 0.3s ease; }
        .user-message { align-self: flex-end; background-color: #0084ff; color: white; border-bottom-right-radius: 4px; }
        .ai-message { align-self: flex-start; background-color: #ffffff; color: #333; box-shadow: 0 1px 2px rgba(0,0,0,0.1); border-bottom-left-radius: 4px;}
        .input-area { background: white; padding: 15px; display: flex; gap: 10px; border-top: 1px solid #ddd; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 20px; outline: none; font-size: 16px;}
        input:focus { border-color: #0084ff; }
        button { padding: 10px 20px; background-color: #0084ff; color: white; border: none; border-radius: 20px; font-weight: bold; cursor: pointer; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .typing-indicator::after { content: '...'; animation: typing 1.5s infinite; }
        @keyframes typing { 0% { content: '.'; } 33% { content: '..'; } 66% { content: '...'; } }
    </style>
</head>
<body>

    <header>ğŸ§  Gemini è®°å¿†ç‰ˆ</header>

    <div id="chat-container">
        <div class="message ai-message">ä½ å¥½ï¼æˆ‘ç°åœ¨æœ‰è®°å¿†äº†ï¼Œæˆ‘ä»¬å¯ä»¥èŠç‚¹è¿è´¯çš„è¯é¢˜ã€‚</div>
    </div>

    <div class="input-area">
        <input type="text" id="userInput" placeholder="å‘æ¶ˆæ¯..." onkeypress="handleKeyPress(event)">
        <button id="sendBtn" onclick="sendMessage()">å‘é€</button>
    </div>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');

        // â˜… æ–°å¢ï¼šè¿™é‡Œç”¨æ¥å­˜æ”¾èŠå¤©è®°å½•
        let conversationHistory = [];

        function appendMessage(text, sender) {
            const div = document.createElement('div');
            div.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message');
            div.innerText = text;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return div;
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter') sendMessage();
        }

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            // 1. UI æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            appendMessage(text, 'user');
            userInput.value = '';
            userInput.disabled = true;
            sendBtn.disabled = true;

            const loadingBubble = appendMessage('æ€è€ƒä¸­', 'ai');
            loadingBubble.classList.add('typing-indicator');

            try {
                // 2. å‘é€è¯·æ±‚ï¼ˆå¸¦ä¸Š historyï¼‰
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        prompt: text,
                        history: conversationHistory // â˜… æŠŠâ€œè®°äº‹æœ¬â€å‘ç»™åç«¯
                    })
                });
                
                const data = await response.json();
                loadingBubble.classList.remove('typing-indicator');
                
                if (data.error) {
                    loadingBubble.innerText = "å‡ºé”™äº†: " + data.error;
                } else {
                    loadingBubble.innerText = data.text;

                    // â˜… 3. æˆåŠŸåï¼Œæ›´æ–°æœ¬åœ°å†å²è®°å½•
                    // å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ Gemini çš„æ ¼å¼è¦æ±‚ï¼š
                    // ç”¨æˆ·çš„è¯ï¼šrole: "user", parts: [{ text: "..." }]
                    // AI çš„è¯ï¼šrole: "model", parts: [{ text: "..." }]
                    
                    conversationHistory.push({
                        role: "user",
                        parts: [{ text: text }]
                    });
                    
                    conversationHistory.push({
                        role: "model",
                        parts: [{ text: data.text }]
                    });
                }

            } catch (e) {
                loadingBubble.innerText = "ç½‘ç»œé”™è¯¯";
            } finally {
                userInput.disabled = false;
                sendBtn.disabled = false;
                userInput.focus();
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }
    </script>
</body>
</html>